<script context="module">
  export const key = 'Animate';
  export const position = 'PrependContainer';
  export const defaults = {
    // Use animate.css to animate the notice.
    animate: false,
    // The class to use to animate the notice in.
    inClass: '',
    // The class to use to animate the notice out.
    outClass: ''
  };
</script>
<script>
  // The PNotify notice.
  export let self = null;

  export let animate = defaults.animate;
  export let inClass = defaults.inClass;
  export let outClass = defaults.outClass;

  let _animateIn;
  let _animateOut;
  let _animation;

  $: {
    if (animate && !_animateIn) {
      _animation = self.animation;
      _animateIn = self.animateIn;
      _animateOut = self.animateOut;
      self.$set({
        animation: 'none',
        animateIn,
        animateOut
      });
    } else if (!animate && _animateIn) {
      self.$set({
        animation: _animation,
        animateIn: _animateIn,
        animateOut: _animateOut
      });
      _animation = null;
      _animateIn = null;
      _animateOut = null;
    }
  }

  self.on('pnotify:update', () => {
    if (animate && self.refs.elem) {
      var animSpeed = 250;
      if (self.animateSpeed === 'slow') {
        animSpeed = 400;
      } else if (self.animateSpeed === 'fast') {
        animSpeed = 100;
      } else if (self.animateSpeed > 0) {
        animSpeed = self.animateSpeed;
      }
      animSpeed = animSpeed / 1000;
      if (self.refs.elem.style.animationDuration !== animSpeed + 's') {
        self.refs.elem.style.animationDuration = animSpeed + 's';
      }
    }
  });

  function animateIn (callback, immediate) {
    // Declare that the notice is animating in.
    self.setAnimating('in');

    let off;
    const finished = event => {
      if (event && self.refs.elem && event.target !== self.refs.elem) {
        return;
      }
      off();
      self.setAnimatingClass('ui-pnotify-in animated');
      if (callback) {
        callback.call();
      }
      // Declare that the notice has completed animating.
      self.setAnimating(false);
    };

    off = self.on('animationend', finished);
    if (immediate) {
      finished();
    } else {
      self.setAnimatingClass('ui-pnotify-in animated ' + inClass);
    }
  }

  function animateOut (callback, immediate) {
    // Declare that the notice is animating out.
    self.setAnimating('out');

    let off;
    const finished = event => {
      if (event && self.refs.elem && event.target !== self.refs.elem) {
        return;
      }
      off();
      self.setAnimatingClass('animated');
      if (callback) {
        callback.call();
      }
      // Declare that the notice has completed animating.
      if (self.setAnimating) {
        self.setAnimating(false);
      }
    };

    off = self.on('animationend', finished);
    if (immediate) {
      finished();
    } else {
      self.setAnimatingClass('ui-pnotify-in animated ' + outClass);
    }
  }

  self.attention = (aniClass, callback) => {
    let off;
    const cb = () => {
      off();
      self.removeModuleClass('container', 'animated', aniClass);
      if (callback) {
        callback.call(self);
      }
    };
    off = self.on('animationend', cb);
    self.addModuleClass('container', 'animated', aniClass);
  };
</script>
